{
    "description": "function composition",
    "script": "return lib.no.default_fn(lib, self)",
    "nodes": [
        {
            "id": "in",
            "script": "return (args) => args.data"
        },
        {
            "id": "flatten",
            "script": "return lib.no.flatten"
        },
        {
            "id": "replace_node_types_args",
            "target_path": ["graph", "nodes"]
        },
        {
            "id": "replace_node_types_fn",
            "script": "return ({data}) => node => lib.no.unpackTypes(data.node_types, node)"
        },
        {
            "id": "replace_node_types",
            "script": "return lib.no.map_path"
        },
        {
            "id": "initial_graph",
            "script": "return ({data}) => {graph: data.target.graph}"
        },
        {
            "id": "hyperapp_view",
            "script": "return lib.no.referenceExecute",
            "nodes": [
                {"id": "in", "script": "return (args) => args.data"},
                {"id": "helloworld", "text": "Hello, world!", "script": "return ({lib, data}) => lib.ha.text(data.text ?? '')"},
                {"id": "out", "type": "end_fn", "script": "return ({data}) => { if(data.end_fn){ state.set('end_fn', data.end_fn); } if(state.has('end_fn')) { state.get('end_fn')(data); }}"}
            ],
            "edges": [
                {"from": "in", "to": "out"},
                {"from": "in", "to": "helloworld" },
                {"from": "helloworld", "to": "out" }
            ]
        },
        {
            "id": "hyperapp",
            "script": "return ({lib, state, data}) => { if(!state.has('dispatch') && data.view && data.dom){ state.set('dispatch', lib.ha.app({ init: data.init ?? {}, view: (s) => data.view(s) ?? lib.ha.text('loading...'), node: data.dom })) }}"
        },
        {
            "id": "content_el_selector",
            "type": "el_selector",
            "selector": "#content"
        },
        {
            "id": "content_el",
            "type": "get",
            "get_index": 0
        },



        {
            "id": "base_editor_view",
            "type": "compiled_fn",
            "nodes": [
                {
                    "id": "base_editor_content",
                    "nodes": [
                        {
                            "id": "node_editor",
                            "type": "execute",
                            "nodes": [
                                {
                                    "id": "parent",
                                    "type": "h",
                                    "dom_type": "svg"
                                },
                                {
                                    "id": "get_input",
                                    "script": "return (state, input) =>  input.node_editor"
                                },
                                {
                                    "id": "svgs",
                                    "type": "aggregate",
                                    "nodes": [
                                        {
                                            "id": "node_svgs",
                                            "type": "aggregate",
                                            "nodes": [],
                                            "edges": []
                                        },
                                        {
                                            "id": "link_svgs",
                                            "type": "aggregate",
                                            "nodes": [],
                                            "edges": []
                                        }
                                    ],
                                    "edges": [
                                        {
                                            "from": "in",
                                            "to": "node_svgs"
                                        },
                                        {
                                            "from": "node_svgs",
                                            "to": "link_svgs"
                                        },
                                        {
                                            "from": "link_svgs",
                                            "to": "out"
                                        }
                                    ]
                                },
                                {
                                    "id": "svgs_flatten",
                                    "script": "return (state, input) => input.target instanceof Map ? new Map([...lib.iter.map(input.target.values(), v => [...v])].flat()) : input.array.flat()"
                                },
                                {
                                    "id": "attrs",
                                    "script": "return (state, input) => ({id: 'node_parent', width: window.innerWidth, height: window.innerHeight})"
                                }
                            ],
                            "edges": [
                                {
                                    "from": "in",
                                    "to": "get_input"
                                },
                                {
                                    "from": "get_input",
                                    "to": "svgs"
                                },
                                {
                                    "from": "in",
                                    "to": "attrs"
                                },
                                {
                                    "from": "attrs",
                                    "to": "parent_input",
                                    "as": "attrs"
                                },
                                {
                                    "from": "svgs",
                                    "to": "svgs_flatten",
                                    "as": "target"
                                },
                                {
                                    "from": "svgs_flatten",
                                    "to": "parent_input",
                                    "as": "children"
                                },
                                {
                                    "from": "parent_input",
                                    "to": "parent"
                                },
                                {
                                    "from": "parent",
                                    "to": "out"
                                }
                            ]
                        },
                        {
                            "id": "text_editor",
                            "type": "execute",
                            "nodes": [
                                {
                                    "id": "h_merge",
                                    "script": "return () => ({})"
                                },
                                {
                                    "id": "h",
                                    "type": "h",
                                    "attrs": {
                                        "id": "text-editor"
                                    },
                                    "dom_type": "div"
                                }
                            ],
                            "edges": [
                                {
                                    "from": "in",
                                    "to": "h_merge"
                                },
                                {
                                    "from": "h_merge",
                                    "to": "h"
                                },
                                {
                                    "from": "h",
                                    "to": "out"
                                }
                            ]
                        }
                    ],
                    "edges": [
                        {
                            "from": "in",
                            "to": "node_editor"
                        },
                        {
                            "from": "node_editor",
                            "to": "text_editor"
                        }
                    ]
                },
                {
                    "id": "base_editor",
                    "type": "h",
                    "dom_type": "div"
                },
                {
                    "id": "apply_node_template",
                    "path": [
                        "nodes",
                        "node_editor",
                        "nodes",
                        "svgs",
                        "nodes",
                        "node_svgs",
                        "nodes"
                    ],
                    "source_path": [
                        "node_editor",
                        "nodes"
                    ],
                    "script": "return lib.no.apply_template(lib, self)",
                    "template": {
                        "type": "execute",
                        "nodes": {
                            "parent": {
                                "type": "h",
                                "dom_type": "svg",
                                "attrs": {
                                    "width": 128,
                                    "height": 64
                                }
                            },
                            "get_input": {
                                "script": "return (state, input) => input.nodes[input.parent]"
                            },
                            "parent_input": "merge",
                            "parent_attrs": {
                                "script": "return (state, input) => ({ x: input.x - 20, y: input.y - 20, id: input.node_id })"
                            },
                            "children": {
                                "type": "aggregate",
                                "nodes": {
                                    "circle": {
                                        "type": "h",
                                        "dom_type": "circle",
                                        "attrs": {
                                            "r": 16,
                                            "cx": 20,
                                            "cy": 20,
                                            "fill": "blue"
                                        }
                                    },
                                    "text": {
                                        "type": "execute",
                                        "nodes": {
                                            "get_id": {
                                                "type": "get",
                                                "index": "node_id"
                                            },
                                            "display_name": {
                                                "type": "h_text",
                                                "text": "hi"
                                            },
                                            "text": {
                                                "type": "h",
                                                "dom_type": "text",
                                                "attrs": {
                                                    "x": 42,
                                                    "y": 22,
                                                    "font-size": 18
                                                }
                                            }
                                        },
                                        "edges": [
                                            {
                                                "from": "in",
                                                "to": "get_id"
                                            },
                                            {
                                                "from": "get_id",
                                                "to": "display_name",
                                                "as": "text"
                                            },
                                            {
                                                "from": "display_name",
                                                "to": "text",
                                                "as": "children"
                                            },
                                            {
                                                "from": "text",
                                                "to": "out"
                                            }
                                        ]
                                    }
                                },
                                "edges": [
                                    {
                                        "from": "in",
                                        "to": "circle"
                                    },
                                    {
                                        "from": "circle",
                                        "to": "text"
                                    }
                                ]
                            }
                        },
                        "edges": [
                            {
                                "from": "in",
                                "to": "get_input"
                            },
                            {
                                "from": "get_input",
                                "to": "parent_attrs"
                            },
                            {
                                "from": "parent_attrs",
                                "to": "parent_input",
                                "as": "attrs"
                            },
                            {
                                "from": "get_input",
                                "to": "children"
                            },
                            {
                                "from": "children",
                                "to": "parent_input",
                                "as": "children"
                            },
                            {
                                "from": "parent_input",
                                "to": "parent"
                            },
                            {
                                "from": "parent",
                                "to": "out"
                            }
                        ]
                    }
                },
                {
                    "id": "apply_link_template",
                    "script": "return lib.no.apply_template(lib, self)",
                    "path": [
                        "nodes",
                        "node_editor",
                        "nodes",
                        "svgs",
                        "nodes",
                        "link_svgs",
                        "nodes"
                    ],
                    "source_path": [
                        "node_editor",
                        "links"
                    ],
                    "template": {
                        "type": "execute",
                        "nodes": {
                            "get_input": {
                                "script": "return (state, input) => input.links[input.parent]"
                            },
                            "attrs": {
                                "script": "return (state, input) => ({x1: input.source.x, y1: input.source.y, x2: input.target.x, y2: input.target.y, stroke: 'black'})"
                            },
                            "line": {
                                "type": "h",
                                "dom_type": "line"
                            }
                        },
                        "edges": [
                            {
                                "from": "in",
                                "to": "get_input"
                            },
                            {
                                "from": "get_input",
                                "to": "attrs"
                            },
                            {
                                "from": "attrs",
                                "to": "line",
                                "as": "attrs"
                            },
                            {
                                "from": "line",
                                "to": "out"
                            }
                        ]
                    }
                },
                {
                    "id": "apply_node_template_run",
                    "type": "run_fn",
                    "run_type": "aggregate"
                }
            ],
            "edges": [
                {
                    "from": "in",
                    "to": "base_editor_content"
                },
                {
                    "from": "in",
                    "to": "apply_fn_in",
                    "as": "source"
                },
                {
                    "from": "in",
                    "to": "apply_fn_in",
                    "as": "source"
                },
                {
                    "from": "apply_fn_in",
                    "to": "apply_node_template"
                },
                {
                    "from": "in",
                    "to": "apply_link_template_in",
                    "as": "source"
                },
                {
                    "from": "base_editor_content",
                    "to": "apply_fn_in",
                    "as": "target"
                },
                {
                    "from": "apply_node_template",
                    "to": "apply_link_template_in",
                    "as": "target"
                },
                {
                    "from": "apply_link_template_in",
                    "to": "apply_link_template"
                },
                {
                    "from": "apply_link_template",
                    "to": "run_in",
                    "as": "fn"
                },
                {
                    "from": "in",
                    "to": "run_in",
                    "as": "data"
                },
                {
                    "from": "run_in",
                    "to": "apply_node_template_run"
                },
                {
                    "from": "apply_node_template_run",
                    "to": "base_editor",
                    "as": "children"
                },
                {
                    "from": "base_editor",
                    "to": "out"
                }
            ]
        },
        {
            "id": "simulate_layout",
            "script": "return (state, input) => (state.has('simulation') ? state : state.set('simulation', lib.no.d3simulation(state, input))).get('simulation')"
        },
        {
            "id": "simulation_dispatch",
            "type": "compiled_fn",
            "nodes": [
                {
                    "id": "get_nodes",
                    "script": "return (state, input) => requestAnimationFrame(() => {if(!(input.dispatch && input.simulation && input.action)){ return } input.dispatch(input.action, { nodes: Object.fromEntries(input.simulation.nodes().map(n => [n.node_id, n])), links: input.simulation.force('links').links()  } ) })"
                }
            ],
            "edges": [
                {
                    "from": "in",
                    "to": "get_nodes"
                },
                {
                    "from": "get_nodes",
                    "to": "out"
                }
            ]
        },
        {
            "id": "simulation_subscription",
            "type": "execute",
            "nodes": [
                {
                    "id": "subscription",
                    "script": "return (state, input) => (dispatch, props) => { input.simulation.on('tick.ha', function(v){ input.fn({simulation: this, dispatch: dispatch, action: props.action})}); return () => input.simulation.on('.ha', null); }"
                }
            ],
            "edges": [
                {
                    "from": "in",
                    "to": "subscription"
                },
                {
                    "from": "subscription",
                    "to": "out"
                }
            ]
        },
        {
            "id": "hyperapp_input",
            "type": "merge"
        },
        {
            "id": "hyperapp_state",
            "script": "return (state, input) => { state.set('input', Object.assign({}, state.get('input') ?? {}, input)); return { node_editor: state.get('input') } }"
        },
        {
            "id": "_hyperapp",
            "script": "return (state, input) => { if(!state.has('dispatch') && input.view && input.dom && input.simulation_subscription){ state.set('dispatch', lib.ha.app({ init: input.init ?? {}, view: (s) => input.view(s) ?? lib.ha.text('loading...'), subscriptions:() => [[input.simulation_subscription, { action: (state, payload) => Object.assign({}, state, {node_editor: payload}) }]] , node: input.dom })); } return state.get('dispatch'); }"
        },
        {
            "id": "node_types",
            "execute": {
                "script": "return lib.no.default_fn(lib, self)"
            },
            "data": {
                "script": "return () => self"
            },
            "el_selector": {
                "script": "return ({data}) => document.querySelector(data.selector);"
            },
            "get": {
                "script": "return ({data}) => data[data.get_index]"
            },
            "constant": {
                "script": "return () => self.value"
            },
            "merge": {
                "script": "return (state, input) => state.set('input', Object.assign({}, state.get('input') ?? {}, input)).get('input')"
            },
            "log": {
                "script": "return (_, input) => console.log(input)"
            },
            "aggregate": {
                "script": "return lib.no.aggregate_fn(lib, self)"
            },
            "fold": {
                "script": "return (state, input) => (val) => lib._.reduce(lib.no.aggregate_fn(lib, self)(state, input), (v, fn) => fn(v), val)"
            },
            "h": {
                "script": "return lib.no.h_fn(lib, self)"
            },
            "h_text": {
                "script": "return (state, input) => lib.ha.text(input.text ?? self.text)"
            },
            "compiled_fn": {
                "script": "const compiled_fn = lib.no.default_fn(lib, self); return (state, fn_input) => (input) => { const result = compiled_fn(state, lib._.merge(fn_input, input)); return (result === undefined ? state : state.set('output', result)).get('output') }"
            },
            "apply_fn": {
                "script": "return (state, input) => lib.util.overPath(self.path)(n => n.map(input.fn))(input.target)"
            },
            "merge_values": {
                "script": "return (state, input) => lib.util.overPath(self.path, {})(v => lib._.merge(v, input.values))"
            },
            "run_fn": {
                "script": "return lib.no.run_fn(lib, self)"
            }
        }
    ],
    "edges": [
        {
            "from": "in",
            "to": "flatten"
        },
        {
            "from": "flatten",
            "to": "node_types"
        },
        {
            "from": "node_types",
            "to": "replace_node_types_fn",
            "as": "node_types"
        },
        {
            "from": "replace_node_types_fn",
            "to": "replace_node_types",
            "as": "map_fn"
        },
        {
            "from": "flatten",
            "to": "replace_node_types_args"
        },
        {
            "from": "replace_node_types_args",
            "to": "replace_node_types"
        },
        {
            "from": "flatten",
            "to": "replace_node_types",
            "as": "target"
        },
        {
            "from": "flatten",
            "to": "replace_node_types_fn"
        },
        {
            "from": "replace_node_types",
            "to": "content_el_selector"
        },
        {
            "from": "replace_node_types",
            "to": "hyperapp_view"
        },
        {
            "from": "replace_node_types",
            "to": "hyperapp"
        },
        {
            "from": "content_el_selector",
            "to": "hyperapp",
            "as": "dom"
        },
        {
            "from": "hyperapp_view",
            "to": "hyperapp_view_in",
            "as": "??"
        },
        {
            "from": "hyperapp_view",
            "to": "hyperapp",
            "as": "view"
        }
    ]
}