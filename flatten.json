{
    "description": "function composition",
    "nodes": [
        {
            "id": "in",
            "script": "return (args) => args.data"
        },
        {
            "id": "flatten",
            "script": "return lib.no.flatten"
        },
        {
            "id": "replace_node_types_args",
            "target_path": [
                "graph",
                "nodes"
            ]
        },
        {
            "id": "replace_node_types_fn",
            "script": "return ({data}) => node => lib.no.unpackTypes(data.node_types, node)"
        },
        {
            "id": "replace_node_types",
            "script": "return lib.no.map_path_fn"
        },
        {
            "id": "initial_graph",
            "script": "return ({data}) => {graph: data.target.graph}"
        },
        {
            "id": "hyperapp_view",
            "nodes": [
                {
                    "id": "in",
                    "type": "fn_def"
                },
                {
                    "id": "out",
                    "type": "fn_return"
                },
                {
                    "id": "get_aggregate",
                    "type": "get",
                    "get_index": "aggregate"
                },
                {
                    "id": "base_editor_content",
                    "nodes": [
                        {
                            "id": "in",
                            "type": "identity"
                        },
                        {
                            "id": "children",
                            "type": "order_inputs",
                            "order": [
                                "node_editor",
                                "text_editor"
                            ]
                        },
                        {
                            "id": "concat_children",
                            "type": "children_els"
                        },
                        {
                            "id": "out",
                            "type": "identity"
                        },
                        {
                            "id": "node_editor",
                            "nodes": [
                                {
                                    "id": "in",
                                    "type": "identity"
                                },
                                {
                                    "id": "out",
                                    "type": "identity"
                                },
                                {
                                    "id": "parent",
                                    "type": "h",
                                    "dom_type": "svg"
                                },
                                {
                                    "id": "get_input",
                                    "script": "return ({data}) =>  data.graph"
                                },
                                {
                                    "id": "svgs",
                                    "nodes": [
                                        {
                                            "id": "in",
                                            "type": "identity"
                                        },
                                        {
                                            "id": "get_nodes",
                                            "type": "get",
                                            "get_index": [
                                                "nodes"
                                            ]
                                        },
                                        {
                                            "id": "get_links",
                                            "type": "get",
                                            "get_index": [
                                                "links"
                                            ]
                                        },
                                        {
                                            "id": "node_svgs",
                                            "script": "return lib.no.iterate"
                                        },
                                        {
                                            "id": "node_template",
                                            "nodes": [
                                                {
                                                    "id": "in",
                                                    "type": "identity"
                                                },
                                                {
                                                    "id": "out",
                                                    "type": "identity"
                                                },
                                                {
                                                    "id": "parent",
                                                    "type": "h",
                                                    "dom_type": "svg",
                                                    "attrs": {
                                                        "width": 128,
                                                        "height": 64
                                                    }
                                                },
                                                {
                                                    "id": "parent_attrs",
                                                    "script": "return ({data}) => ({ x: (data.x ?? 400) - 20, y: (data.y ?? 400) - 20, id: data.node_id })"
                                                },
                                                {
                                                    "id": "children",
                                                    "nodes": [
                                                        {
                                                            "id": "circle",
                                                            "type": "h",
                                                            "dom_type": "circle",
                                                            "attrs": {
                                                                "r": 16,
                                                                "cx": 20,
                                                                "cy": 20,
                                                                "fill": "blue"
                                                            }
                                                        },
                                                        {
                                                            "id": "text",
                                                            "nodes": [
                                                                {
                                                                    "id": "in",
                                                                    "type": "identity"
                                                                },
                                                                {
                                                                    "id": "out",
                                                                    "type": "identity"
                                                                },
                                                                {
                                                                    "id": "get_id",
                                                                    "type": "get",
                                                                    "get_index": "node_id"
                                                                },
                                                                {
                                                                    "id": "display_name",
                                                                    "type": "h_text",
                                                                    "text": "hi"
                                                                },
                                                                {
                                                                    "id": "text",
                                                                    "type": "h",
                                                                    "dom_type": "text",
                                                                    "attrs": {
                                                                        "x": 42,
                                                                        "y": 22,
                                                                        "font-size": 18
                                                                    }
                                                                }
                                                            ],
                                                            "edges": [
                                                                {
                                                                    "from": "in",
                                                                    "to": "get_id"
                                                                },
                                                                {
                                                                    "from": "in",
                                                                    "to": "display_name"
                                                                },
                                                                {
                                                                    "from": "display_name",
                                                                    "to": "text",
                                                                    "as": "children"
                                                                },
                                                                {
                                                                    "from": "text",
                                                                    "to": "out"
                                                                }
                                                            ]
                                                        },
                                                        {
                                                            "id": "in",
                                                            "type": "identity"
                                                        },
                                                        {
                                                            "id": "order",
                                                            "type": "order_inputs",
                                                            "order": [
                                                                "circle",
                                                                "text"
                                                            ]
                                                        },
                                                        {
                                                            "id": "children_els",
                                                            "type": "children_els"
                                                        },
                                                        {
                                                            "id": "out",
                                                            "type": "identity"
                                                        }
                                                    ],
                                                    "edges": [
                                                        {
                                                            "from": "in",
                                                            "to": "circle"
                                                        },
                                                        {
                                                            "from": "in",
                                                            "to": "text"
                                                        },
                                                        {
                                                            "from": "circle",
                                                            "to": "order",
                                                            "as": "circle"
                                                        },
                                                        {
                                                            "from": "text",
                                                            "to": "order",
                                                            "as": "text"
                                                        },
                                                        {
                                                            "from": "order",
                                                            "to": "children_els",
                                                            "as": "children"
                                                        },
                                                        {
                                                            "from": "children_els",
                                                            "to": "out",
                                                            "as": "children"
                                                        }
                                                    ]
                                                }
                                            ],
                                            "edges": [
                                                {
                                                    "from": "parent_attrs",
                                                    "to": "parent",
                                                    "as": "attrs"
                                                },
                                                {
                                                    "from": "in",
                                                    "to": "children"
                                                },
                                                {
                                                    "from": "children",
                                                    "to": "parent"
                                                },
                                                {
                                                    "from": "parent",
                                                    "to": "out"
                                                }
                                            ]
                                        },
                                        {
                                            "id": "link_svgs",
                                            "script": "return lib.no.iterate"
                                        },
                                        {
                                            "id": "link_template",
                                            "nodes": [
                                                {"id": "attrs",
                                                    "script": "return ({data}) => ({x1: data.source.x, y1: data.source.y, x2: input.target.x, y2: data.target.y, stroke: 'black'})"
                                                },
                                                {"id": "line",
                                                    "type": "h",
                                                    "dom_type": "line"
                                                },
                                                {
                                                    "id": "in",
                                                    "type": "identity"
                                                },
                                                {
                                                    "id": "out",
                                                    "type": "identity"
                                                }
                                            ],
                                            "edges": [
                                                {
                                                    "from": "in",
                                                    "to": "attrs"
                                                },
                                                {
                                                    "from": "attrs",
                                                    "to": "line",
                                                    "as": "attrs"
                                                },
                                                {
                                                    "from": "line",
                                                    "to": "out"
                                                }
                                            ]
                                        },
                                        {
                                            "id": "concat_links",
                                            "type": "concat"
                                        },
                                        {
                                            "id": "concat_nodes",
                                            "type": "concat"
                                        },
                                        {
                                            "id": "concat_all",
                                            "script": "return ({data}) => data.links && data.nodes && [].concat(data.links ?? [], data.nodes)"
                                        },
                                        {
                                            "id": "children_els",
                                            "script": "return ({data}) => data.children.reduce((acc, c) => (acc.push(c.el), acc), [])"
                                        },
                                        {
                                            "id": "out",
                                            "type": "identity"
                                        }
                                    ],
                                    "edges": [
                                        {
                                            "from": "in",
                                            "to": "get_nodes"
                                        },
                                        {
                                            "from": "in",
                                            "to": "get_links"
                                        },
                                        {
                                            "from": "get_nodes",
                                            "to": "node_svgs",
                                            "as": "target"
                                        },
                                        {
                                            "from": "get_links",
                                            "to": "link_svgs",
                                            "as": "target"
                                        },
                                        {
                                            "from": "node_svgs",
                                            "to": "node_template"
                                        },
                                        {
                                            "from": "link_svgs",
                                            "to": "link_template"
                                        },
                                        {
                                            "from": "node_template",
                                            "to": "concat_nodes",
                                            "as": "value"
                                        },
                                        {
                                            "from": "link_template",
                                            "to": "concat_links",
                                            "as": "value"
                                        },
                                        {
                                            "from": "concat_nodes",
                                            "to": "concat_all",
                                            "as": "nodes"
                                        },
                                        {
                                            "from": "concat_links",
                                            "to": "concat_all",
                                            "as": "links"
                                        },
                                        {
                                            "from": "concat_all",
                                            "to": "children_els",
                                            "as": "children"
                                        },
                                        {
                                            "from": "children_els",
                                            "to": "out",
                                            "as": "children"
                                        }
                                    ]
                                },
                                {
                                    "id": "svgs_flatten",
                                    "script": "return ({data}) => data.target instanceof Map ? new Map([...lib.iter.map(data.target.values(), v => [...v])].flat()) : data.target.flat()"
                                },
                                {
                                    "id": "attrs",
                                    "script": "return () => ({id: 'node_parent', width: window.innerWidth, height: window.innerHeight})"
                                }
                            ],
                            "edges": [
                                {
                                    "from": "in",
                                    "to": "get_input"
                                },
                                {
                                    "from": "get_input",
                                    "to": "svgs"
                                },
                                {
                                    "from": "in",
                                    "to": "attrs"
                                },
                                {
                                    "from": "attrs",
                                    "to": "parent",
                                    "as": "attrs"
                                },
                                {
                                    "from": "svgs",
                                    "to": "parent"
                                },
                                {
                                    "from": "parent",
                                    "to": "out"
                                }
                            ]
                        },
                        {
                            "id": "text_editor",
                            "type": "h",
                            "attrs": {
                                "id": "text-editor"
                            },
                            "dom_type": "div"
                        }
                    ],
                    "edges": [
                        {
                            "from": "in",
                            "to": "node_editor"
                        },
                        {
                            "from": "in",
                            "to": "text_editor"
                        },
                        {
                            "from": "node_editor",
                            "to": "children",
                            "as": "node_editor"
                        },
                        {
                            "from": "text_editor",
                            "to": "children",
                            "as": "text_editor"
                        },
                        {
                            "from": "children",
                            "to": "concat_children",
                            "as": "children"
                        },
                        {
                            "from": "concat_children",
                            "to": "out",
                            "as": "children"
                        }
                    ]
                },
                {
                    "id": "base_editor",
                    "type": "h",
                    "dom_type": "div"
                },
                {
                    "id": "apply_node_template",
                    "path": [
                        "nodes",
                        "node_editor",
                        "nodes",
                        "svgs",
                        "nodes",
                        "node_svgs",
                        "nodes"
                    ],
                    "source_path": [
                        "node_editor",
                        "nodes"
                    ],
                    "script": "return lib.no.apply_template(lib, self)",
                    "template": {}
                },
                {
                    "id": "simulation_dispatch",
                    "type": "compiled_fn",
                    "nodes": [
                        {
                            "id": "in",
                            "type": "identity"
                        },
                        {
                            "id": "out",
                            "type": "identity"
                        },
                        {
                            "id": "get_nodes",
                            "script": "return (state, input) => requestAnimationFrame(() => {if(!(input.dispatch && input.simulation && input.action)){ return }  })"
                        }
                    ],
                    "edges": [
                        {
                            "from": "in",
                            "to": "get_nodes"
                        },
                        {
                            "from": "get_nodes",
                            "to": "out"
                        }
                    ]
                },
                {
                    "id": "concat_children",
                    "type": "children_els"
                }
            ],
            "edges": [
                {
                    "from": "in",
                    "to": "base_editor_content"
                },
                {
                    "from": "base_editor_content",
                    "to": "base_editor"
                },
                {
                    "from": "base_editor",
                    "to": "out"
                }
            ]
        },
                {
                    "id": "simulation_subscription",
                    "nodes": [
                        {
                            "id": "in",
                            "type": "identity"
                        },
                        {
                            "id": "out",
                            "type": "identity"
                        },
                        {
                            "id": "subscription",
                            "script": "return ({data}) => (dispatch, props) => { data.simulation.on('tick.ha', function(v){ dispatch(s => s, { nodes: Object.fromEntries(data.simulation.nodes().map(n => [n.node_id, n])), links: data.simulation.force('links').links()  } ) }); return () => input.simulation.on('.ha', null); }"
                        }
                    ],
                    "edges": [
                        {
                            "from": "in",
                            "to": "subscription"
                        },
                        {
                            "from": "subscription",
                            "to": "out",
                            "as": "subscription"
                        }
                    ]
                },
                {
                    "id": "simulate_layout",
                    "script": "return ({state, data}) => (state.has('simulation') ? state : state.set('simulation', lib.no.d3simulation({data, state}))).get('simulation')"
                },
        {
            "id": "hyperapp",
            "script": "return ({lib, state, data}) => { if(!state.has('dispatch') && data.view && data.dom && data.subscription){ state.set('dispatch', lib.ha.app({ init: data.init ?? {nodes: [], links: []}, view: (s) => data.view(s).el ?? lib.ha.text('loading...'), node: data.dom, subscriptions: () => [[data.subscription]] })) }}"
        },
        {
            "id": "content_el_selector",
            "type": "el_selector",
            "selector": "#content"
        },
        {
            "id": "content_el",
            "type": "get",
            "get_index": 0
        },
        {
            "id": "verify",
            "script": "return lib.no.verify"
        },
        {
            "id": "node_types",
            "execute": {
                "script": "return lib.no.default_fn(lib, self)"
            },
            "data": {
                "script": "return () => self"
            },
            "el_selector": {
                "script": "return ({data}) => document.querySelector(data.selector);"
            },
            "get": {
                "script": "return ({data}) => lib._.get(data, data.get_index)"
            },
            "constant": {
                "script": "return () => self.value"
            },
            "log": {
                "script": "return ({data}) => console.log(data)"
            },
            "aggregate_chain": {
                "script": "return lib.no.aggregateChain"
            },
            "concat": {
                "script": "return lib.no.concatValues"
            },
            "h": {
                "script": "return lib.no.hFn"
            },
            "h_text": {
                "script": "return ({data}) => lib.ha.text(data.text)"
            },
            "fn_def": {
                "script": "return lib.no.fnDef"
            },
            "fn_return": {
                "script": "return lib.no.fnReturn"
            },
            "identity": {
                "script": "return ({data}) => data"
            },
            "order_inputs": {
                "script": "return ({data}) => ({value: data.order.map(o => data[o]).reduce((acc, v) => v === undefined || acc.ordered === undefined ? {} : {ordered: acc.ordered.concat([v])}, {ordered: []}).ordered, delete: ['order'] })"
            },
            "children_els": {
                "script": "return ({data}) => ({value: data.children.reduce((acc, c) => (acc.push(c.el), acc), []).filter(v => v), delete: ['children'] })"
            }
        },
        {
            "id": "log",
            "type": "log"
        }
    ],
    "edges": [
        {"from": "hyperapp_view/base_editor_content/children", "to": "log"},
        {
            "from": "in",
            "to": "flatten"
        },
        {
            "from": "flatten",
            "to": "verify"
        },
        {
            "from": "verify",
            "to": "node_types"
        },
        {
            "from": "node_types",
            "to": "replace_node_types_fn",
            "as": "node_types"
        },
        {
            "from": "replace_node_types_fn",
            "to": "replace_node_types",
            "as": "map_fn"
        },
        {
            "from": "verify",
            "to": "replace_node_types_args"
        },
        {
            "from": "replace_node_types_args",
            "to": "replace_node_types"
        },
        {
            "from": "verify",
            "to": "replace_node_types",
            "as": "target"
        },
        {
            "from": "verify",
            "to": "replace_node_types_fn"
        },
        {
            "from": "replace_node_types",
            "to": "content_el_selector"
        },
        {
            "from": "replace_node_types",
            "to": "hyperapp_view"
        },
        {
            "from": "replace_node_types",
            "to": "simulate_layout"
        },
        {
            "from": "simulate_layout",
            "to": "simulation_subscription",
            "as": "simulation"
        },
        {
            "from": "simulation_subscription",
            "to": "hyperapp"
        },
        {
            "from": "replace_node_types",
            "to": "hyperapp"
        },
        {
            "from": "content_el_selector",
            "to": "hyperapp",
            "as": "dom"
        },
        {
            "from": "hyperapp_view",
            "to": "hyperapp",
            "as": "view"
        }
    ]
}